<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      lang="en"
      metal:use-macro="context/main_template/macros/master"
      i18n:domain="plone">

<body>
<div metal:fill-slot="main">
<form action="" method="get" accept-charset="utf-8" id="advancedsearch">

<div id="archetypes-fieldname-query"
     class="field ArchetypesQueryWidget"
     tal:define="config python:view.getConfig();
                 indexes config/indexes;
                 sortable_indexes config/sortable_indexes;
                 addindexselected python:request.has_key('addindex') and request.addindex != '';
                 addoperatorselected python:request.has_key('addoperator') and request.addoperator != ''">
<span></span>
<label for="query" class="formQuestion">Query</label>
<div id="query_help" class="formHelp">Used to specify the query.</div>
<div class="fieldErrorBox"></div>



        <fieldset>
            <legend>Criteria</legend>
            <tal:counter tal:define="dummy python:request.set('querystringwidgetcounter', 0)"/>
            <tal:row repeat="row context/getQueryDict">
            <div class="field"
                 tal:condition="python:not request.has_key('removecriteria.%s' % repeat['row'].index)">
                <div class="queryindex">
                    <input type="hidden" name="query.i:records"
                           tal:attributes="value row/i" />
                    <span tal:content="python:indexes[row.i]['friendly_name']"/>
                </div>

                <div class="queryoperator">
                    <input type="hidden" name="query.o:records"
                           tal:attributes="value row/o" />
                    <span tal:content="python:indexes[row.i]['operators'][row.o]['friendly_name']"/>
                </div>

                <input class="querywidget queryvalue stringWidget"
                       autocomplete="off" type="text" name="query.v:records"
                       tal:attributes="value python:row['v']"
                       tal:condition="python:indexes[row.i]['operators'][row.o]['widget'] == 'StringWidget'"/>

                <dl class="querywidget queryvalue multipleSelectionWidget"
                     tal:condition="python:indexes[row.i]['operators'][row.o]['widget'] == 'MultipleSelectionWidget'">
                    <dt class="hiddenStructure"><span>Select...</span><span class="arrowDownAlternative">â–¼</span></dt>
                    <dd>
                    <tal:values repeat="index python:indexes[row.i]['values'].keys()">
                    <label>
                        <input type="checkbox" name="query.v:records:list"
                               tal:attributes="value index;
                                               checked python: row.has_key('v') and index in row.v and 'checked' or nothing"/>
                        <span tal:content="python:indexes[row.i]['values'][index]['friendly_name']"/>
                    </label>
                    </tal:values>
                    </dd>
                </dl>

                <dl class="querywidget referenceWidget"
                     tal:condition="python:indexes[row.i]['operators'][row.o]['widget'] == 'ReferenceWidget'">
                    <dt class="hiddenStructure">Select...</dt>
                    <dd>
                        <input class="queryvalue" autocomplete="off" type="text" name="query.v:records" tal:attributes="value python:row['v']" />
                    </dd>
                </dl>

                <input class="querywidget queryvalue dateWidget"
                       autocomplete="off" type="text" class="queryvalue" name="query.v:records"
                       tal:attributes="value python:row['v']"
                       tal:condition="python:indexes[row.i]['operators'][row.o]['widget'] == 'DateWidget'"/>

                <div class="querywidget queryvalue dateRangeWidget"
                     tal:condition="python:indexes[row.i]['operators'][row.o]['widget'] == 'DateRangeWidget'">
                    <input autocomplete="off" type="text" name="query.v:records:list"
                           tal:attributes="value python:row['v'][0]"/>
                    <span> and </span>
                    <input autocomplete="off" type="text" name="query.v:records:list"
                           tal:attributes="value python:row['v'][1]"/>
                </div>

                <input class="querywidget queryvalue relativePathWidget"
                       autocomplete="off" type="text" class="queryvalue" name="query.v:records"
                       tal:attributes="value python:row['v']"
                       tal:condition="python:indexes[row.i]['operators'][row.o]['widget'] == 'RelativePathWidget'"/>

                <input type="submit" class="removecriteria discreet" value="Remove criterion"
                    tal:attributes="name python:'removecriteria.%s' % request.get('querystringwidgetcounter')"/>
                <tal:counter tal:define="dummy python:request.set('querystringwidgetcounter', request.get('querystringwidgetcounter') + 1)"/>
            </div>
            </tal:row>

            <div class="field" tal:condition="python: addindexselected and addoperatorselected">

                <div class="queryindex">
                    <input type="hidden" name="query.i:records"
                           tal:attributes="value context/REQUEST/form/addindex" />
                    <span tal:content="python:indexes[request.form['addindex']]['friendly_name']"/>
                </div>

                <div class="queryoperator">
                    <input type="hidden" name="query.o:records"
                           tal:attributes="value context/REQUEST/form/addoperator" />
                    <span tal:content="python:indexes[request.form['addindex']]['operators'][request.form['addoperator']]['friendly_name']"/>
                </div>

                <input class="querywidget queryvalue stringWidget"
                       autocomplete="off" type="text" name="query.v:records" value=""
                       tal:condition="python:indexes[request.form['addindex']]['operators'][request.form['addoperator']]['widget'] == 'StringWidget'"/>

                <dl class="querywidget queryvalue multipleSelectionWidget"
                     tal:condition="python:indexes[request.form['addindex']]['operators'][request.form['addoperator']]['widget'] == 'MultipleSelectionWidget'">
                    <dt class="hiddenStructure">Select...</dt>
                    <dd>
                        <tal:values repeat="index python:indexes[request.form['addindex']]['values'].keys()">
                        <label>
                            <input type="checkbox" name="query.v:records:list" tal:attributes="value index"/>
                            <span tal:content="python:indexes[request.form['addindex']]['values'][index]['friendly_name']"/>
                        </label>
                        </tal:values>
                    </dd>
                </dl>

                <div class="querywidget referenceWidget"
                     tal:condition="python:indexes[request.form['addindex']]['operators'][request.form['addoperator']]['widget'] == 'ReferenceWidget'">
                    <dl>
                        <dt class="hiddenStructure">Select...</dt>
                        <dd><input class="queryvalue" autocomplete="off" type="text" name="query.v:records"/></dd>
                    </dl>
                </div>

                <div class="querywidget queryvalue dateWidget"
                     tal:condition="python:indexes[request.form['addindex']]['operators'][request.form['addoperator']]['widget'] == 'DateWidget'">
                     <input autocomplete="off" type="text" class="queryvalue" name="query.v:records"/>
                </div>

                <div class="querywidget queryvalue dateRangeWidget"
                     tal:condition="python:indexes[request.form['addindex']]['operators'][request.form['addoperator']]['widget'] == 'DateRangeWidget'">
                    <input autocomplete="off" type="text" name="query.v:records:list"/>
                    <span> and </span>
                    <input autocomplete="off" type="text" name="query.v:records:list"/>
                </div>

                <input class="querywidget queryvalue relativePathWidget"
                       autocomplete="off" type="text" name="query.v:records" value=""
                       tal:condition="python:indexes[request.form['addindex']]['operators'][request.form['addoperator']]['widget'] == 'RelativePathWidget'"/>

                <input type="submit" name="removecriteria" class="removecriteria discreet" value="Remove criterion">
            </div>

            <div class="field">
                <label for="addindex" class="hiddenStructure">Add criterion</label>

                <select class="addIndex" name="addindex" tal:condition="python: not(addindexselected) or addoperatorselected">
                    <option value="" selected="selected">Add criterion...</option>
                    <tal:index repeat="index python:indexes.keys()">
                    <option tal:attributes="value index;"
                            tal:content="python:indexes[index]['friendly_name']">Index</option>
                    </tal:index>
                </select>

                <div class="addIndex" tal:condition="python: addindexselected and not(addoperatorselected)">
                    <input type="hidden" name="addindex"
                           tal:attributes="value context/REQUEST/form/addindex"/>
                    <span tal:content="python:indexes[request.form['addindex']]['friendly_name']"/>
                </div>

                <select class="addOperator" name="addoperator" tal:condition="python: addindexselected and not(addoperatorselected)">
                    <option value="" selected="selected">Add criterion...</option>
                    <tal:index repeat="index python:indexes[request.form['addindex']]['operators'].keys()">
                    <option tal:attributes="value index;"
                            tal:content="python:indexes[request.form['addindex']]['operators'][index]['friendly_name']">Index</option>
                    </tal:index>
                </select>

                <input type="submit" value="Add criterion" name="form.button.addcriteria" class="context addIndexButton"/>
            </div>
        </fieldset>

        <fieldset>
            <legend>Display options</legend>

            <div class="sortingField">
                <div class="formHelp"><!-- --></div>
                <label for="sort_on">
                    Sort on
                </label>
                <select name="sort_on" id="sort_on">
                    <tal:index repeat="index python:sortable_indexes.keys()">
                        <option tal:attributes="value index; selected python:(request.has_key('sort_on') and request.sort_on == index) and 'selected' or nothing"
                                tal:content="python:sortable_indexes[index]['friendly_name']">Index</option>
                    </tal:index>
                </select>

                <input type="checkbox" name="sort_order" value="reverse" checked="checked" id="sort_order"/>
                <label for="sort_order">Reversed order</label>
            </div>

        </fieldset>

        <div class="formControls">
            <input type="submit" value="Save" name="form.button.save" class="context"/>
        </div>
    <div class="previewresults" tal:content="structure view/previewSearchResults">
    </div>
</div>

</form>
</div>
</body>
</html>
